import React from 'react';
import { NativeStackScreenProps } from '@react-navigation/native-stack';
import { useForm, Controller } from 'react-hook-form';
import { ScrollView, Alert, TouchableOpacity } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { MainStack } from '../../utils/ParamList';
import BaseScreenComponent from '../../components/BaseScreenComponent';
import Box from '../../components/Box';
import Text from '../../components/Text';
import Button from '../../components/Button';
import Input from '../../components/Input';
import ImagePickerComponent from '../../components/ImagePicker';
import { useGetInfoQuery, useUpdateProfileInfoMutation, useUpdateProfilePicMutation } from '../../state/services/users.service';
import { useThemeColors } from '../../hooks/useTheme';

type Props = NativeStackScreenProps<MainStack, 'EditProfile'>;

interface ProfileForm {
  fullName: string;
  occupation: string;
  location: string;
  bio: string;
  dateOfBirth: string;
}

const EditProfileScreen = ({ navigation }: Props) => {
  const { label } = useThemeColors();\n  const { data: profile } = useGetInfoQuery();\n  const [updateProfile, { isLoading }] = useUpdateProfileInfoMutation();\n  const [updateProfilePic, { isLoading: isUploadingImage }] = useUpdateProfilePicMutation();\n\n  const user = profile?.data?.user;\n\n  const { control, handleSubmit, formState: { errors } } = useForm<ProfileForm>({\n    defaultValues: {\n      fullName: user?.fullName || '',\n      occupation: user?.occupation || '',\n      location: user?.location || '',\n      bio: user?.bio || '',\n      dateOfBirth: user?.dateOfBirth || '',\n    },\n  });\n\n  const onSubmit = async (data: ProfileForm) => {\n    try {\n      const result = await updateProfile(data).unwrap();\n      if (result.success) {\n        Alert.alert('Success', 'Profile updated successfully');\n        navigation.goBack();\n      }\n    } catch (error: any) {\n      Alert.alert('Error', error?.data?.message || 'Failed to update profile');\n    }\n  };\n\n  const handleImageSelected = async (uri: string) => {\n    if (!uri) return;\n    \n    try {\n      const formData = new FormData();\n      formData.append('profilePic', {\n        uri,\n        type: 'image/jpeg',\n        name: 'profile.jpg',\n      } as any);\n      \n      const result = await updateProfilePic(formData).unwrap();\n      if (result.success) {\n        Alert.alert('Success', 'Profile picture updated successfully');\n      }\n    } catch (error: any) {\n      Alert.alert('Error', error?.data?.message || 'Failed to update profile picture');\n    }\n  };\n\n  return (\n    <BaseScreenComponent>\n      <Box flex={1} backgroundColor=\"background\">\n        {/* Header */}\n        <Box \n          flexDirection=\"row\" \n          alignItems=\"center\" \n          justifyContent=\"space-between\"\n          paddingHorizontal=\"l\"\n          paddingVertical=\"m\"\n        >\n          <TouchableOpacity onPress={() => navigation.goBack()}>\n            <Ionicons name=\"arrow-back\" size={24} color={label} />\n          </TouchableOpacity>\n          \n          <Text variant=\"bold\" fontSize={18}>\n            Edit Profile\n          </Text>\n          \n          <Box width={24} />\n        </Box>\n\n        <ScrollView showsVerticalScrollIndicator={false}>\n          <Box paddingHorizontal=\"l\" gap=\"l\">\n            {/* Profile Picture */}\n            <Box alignItems=\"center\" marginVertical=\"l\">\n              <ImagePickerComponent\n                onImageSelected={handleImageSelected}\n                currentImage={user?.avatar}\n                placeholder=\"Update Photo\"\n                size={120}\n              />\n              {isUploadingImage && (\n                <Text variant=\"regular\" fontSize={12} color=\"label\" marginTop=\"s\">\n                  Uploading...\n                </Text>\n              )}\n            </Box>\n\n            {/* Form */}\n            <Controller\n              control={control}\n              name=\"fullName\"\n              render={({ field: { onChange, onBlur, value } }) => (\n                <Input\n                  label=\"Full Name\"\n                  placeholder=\"Enter your full name\"\n                  value={value}\n                  onChangeText={onChange}\n                  onBlur={onBlur}\n                  error={errors.fullName?.message}\n                />\n              )}\n            />\n\n            <Controller\n              control={control}\n              name=\"occupation\"\n              render={({ field: { onChange, onBlur, value } }) => (\n                <Input\n                  label=\"Occupation\"\n                  placeholder=\"Enter your occupation\"\n                  value={value}\n                  onChangeText={onChange}\n                  onBlur={onBlur}\n                  error={errors.occupation?.message}\n                />\n              )}\n            />\n\n            <Controller\n              control={control}\n              name=\"location\"\n              render={({ field: { onChange, onBlur, value } }) => (\n                <Input\n                  label=\"Location\"\n                  placeholder=\"Enter your location\"\n                  value={value}\n                  onChangeText={onChange}\n                  onBlur={onBlur}\n                  error={errors.location?.message}\n                />\n              )}\n            />\n\n            <Controller\n              control={control}\n              name=\"bio\"\n              render={({ field: { onChange, onBlur, value } }) => (\n                <Input\n                  label=\"Bio\"\n                  placeholder=\"Tell us about yourself\"\n                  value={value}\n                  onChangeText={onChange}\n                  onBlur={onBlur}\n                  error={errors.bio?.message}\n                  height={100}\n                  multiline\n                />\n              )}\n            />\n\n            <Controller\n              control={control}\n              name=\"dateOfBirth\"\n              render={({ field: { onChange, onBlur, value } }) => (\n                <Input\n                  label=\"Date of Birth\"\n                  placeholder=\"YYYY-MM-DD\"\n                  value={value}\n                  onChangeText={onChange}\n                  onBlur={onBlur}\n                  error={errors.dateOfBirth?.message}\n                />\n              )}\n            />\n\n            <Button\n              displayText=\"Save Changes\"\n              onPress={handleSubmit(onSubmit)}\n              loading={isLoading}\n            />\n\n            {/* Additional Options */}\n            <Box gap=\"s\" marginTop=\"l\">\n              <TouchableOpacity onPress={() => navigation.navigate('UpdateContact' as any)}>\n                <Box \n                  flexDirection=\"row\" \n                  alignItems=\"center\" \n                  justifyContent=\"space-between\"\n                  paddingVertical=\"m\"\n                  borderBottomWidth={1}\n                  borderBottomColor=\"faded_border\"\n                >\n                  <Text variant=\"medium\" fontSize={16}>\n                    Update Contact Info\n                  </Text>\n                  <Ionicons name=\"chevron-forward\" size={20} color={label} />\n                </Box>\n              </TouchableOpacity>\n\n              <TouchableOpacity onPress={() => navigation.navigate('ManageSkills' as any)}>\n                <Box \n                  flexDirection=\"row\" \n                  alignItems=\"center\" \n                  justifyContent=\"space-between\"\n                  paddingVertical=\"m\"\n                  borderBottomWidth={1}\n                  borderBottomColor=\"faded_border\"\n                >\n                  <Text variant=\"medium\" fontSize={16}>\n                    Manage Skills\n                  </Text>\n                  <Ionicons name=\"chevron-forward\" size={20} color={label} />\n                </Box>\n              </TouchableOpacity>\n            </Box>\n          </Box>\n        </ScrollView>\n      </Box>\n    </BaseScreenComponent>\n  );\n};\n\nexport default EditProfileScreen;